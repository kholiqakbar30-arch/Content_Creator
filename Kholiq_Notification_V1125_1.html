<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Stream Ninja Notification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: transparent;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        
        .notification-overlay {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        /* Debug panel - bisa dihide di production */
        .debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            display: none; /* Set to 'block' for debugging */
        }
    </style>
</head>
<body>
    <!-- Audio elements untuk notifikasi -->
    <div class="notification-overlay">
        <audio id="notificationSound1" preload="auto">
            <source src="https://kholiqakbar30-arch.github.io/Content_Creator/notif.mp3?session=aSdyhR7fWp&v=1" type="audio/mpeg">
        </audio>
        <audio id="notificationSound2" preload="auto">
            <source src="https://kholiqakbar30-arch.github.io/Content_Creator/notif.mp3?session=aSdyhR7fWp&v=2" type="audio/mpeg">
        </audio>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div>Social Stream Ninja Notifier</div>
        <div id="status">Waiting for messages...</div>
        <div id="lastAction">No actions yet</div>
    </div>

    <script>
        class SocialStreamNotifier {
            constructor() {
                this.audioElements = [
                    document.getElementById('notificationSound1'),
                    document.getElementById('notificationSound2')
                ];
                this.currentIndex = 0;
                this.isInitialized = false;
                this.debugPanel = document.getElementById('debugPanel');
                this.statusElement = document.getElementById('status');
                this.lastActionElement = document.getElementById('lastAction');
                
                this.init();
            }
            
            init() {
                console.log('ðŸš€ Social Stream Ninja Notifier Initializing...');
                this.updateStatus('System starting...');
                
                // Preload audio elements
                this.audioElements.forEach((audio, index) => {
                    audio.preload = 'auto';
                    audio.volume = 1.0;
                    
                    audio.addEventListener('canplaythrough', () => {
                        console.log(`âœ… Audio ${index + 1} ready`);
                        this.updateStatus(`Audio ${index + 1} loaded`);
                    });
                    
                    audio.addEventListener('error', (e) => {
                        console.error(`âŒ Audio ${index + 1} error:`, e);
                        this.updateStatus(`Audio ${index + 1} error`);
                    });
                });

                // Setup message listeners
                this.setupMessageListeners();
                
                setTimeout(() => {
                    this.isInitialized = true;
                    this.updateStatus('âœ… Ready - Listening for Social Stream Ninja');
                    this.logAction('System initialized successfully');
                }, 1000);
            }
            
            setupMessageListeners() {
                // Method 1: PostMessage dari OBS/Social Stream Ninja
                window.addEventListener('message', (event) => {
                    this.handleIncomingMessage(event);
                });
                
                // Method 2: Custom Events
                window.addEventListener('socialStreamEvent', (event) => {
                    this.handleSocialStreamEvent(event);
                });
                
                // Method 3: DOM Events (untuk testing)
                document.addEventListener('click', (event) => {
                    // Jika diklik di OBS browser source, trigger notifikasi
                    this.logAction('Click detected - simulating message');
                    this.playNotification();
                });
                
                // Method 4: Keyboard events untuk testing
                document.addEventListener('keydown', (event) => {
                    if (event.key === ' ') {
                        this.logAction('Spacebar pressed - simulating message');
                        this.playNotification();
                    }
                });

                // Method 5: Custom function untuk dipanggil external
                window.socialStreamNotify = () => {
                    this.logAction('External function called');
                    this.playNotification();
                };
            }
            
            handleIncomingMessage(event) {
                const message = event.data;
                this.logAction(`Received message: ${JSON.stringify(message)}`);
                
                // Handle berbagai format message dari Social Stream Ninja
                if (this.isSocialStreamMessage(message)) {
                    this.logAction('Social Stream Ninja message detected');
                    this.playNotification();
                }
                
                // Format 1: Object dengan type
                if (message && message.type === 'social-stream-event') {
                    this.logAction('Social Stream event type detected');
                    this.playNotification();
                }
                
                // Format 2: Object dengan action
                if (message && message.action === 'new_message') {
                    this.logAction('New message action detected');
                    this.playNotification();
                }
                
                // Format 3: Simple string
                if (typeof message === 'string') {
                    if (message.includes('social') || message.includes('stream') || 
                        message.includes('ninja') || message.includes('message')) {
                        this.logAction('Social Stream keyword detected');
                        this.playNotification();
                    }
                }
            }
            
            handleSocialStreamEvent(event) {
                this.logAction('Custom social stream event received');
                this.playNotification();
            }
            
            isSocialStreamMessage(message) {
                if (!message) return false;
                
                // Cek berbagai kemungkinan format message Social Stream Ninja
                const strMessage = JSON.stringify(message).toLowerCase();
                const keywords = [
                    'social', 'stream', 'ninja', 'message', 'chat', 
                    'comment', 'new_message', 'notification'
                ];
                
                return keywords.some(keyword => strMessage.includes(keyword));
            }
            
            playNotification() {
                if (!this.isInitialized) {
                    this.logAction('System not ready yet');
                    return;
                }
                
                const audio = this.audioElements[this.currentIndex];
                
                try {
                    // Stop dan reset
                    audio.pause();
                    audio.currentTime = 0;
                    
                    // Play dengan error handling
                    const playPromise = audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            this.logAction('ðŸ”Š Notification played successfully');
                            this.updateStatus('Notification played');
                        }).catch(error => {
                            console.error('Playback failed:', error);
                            this.fallbackPlay();
                        });
                    }
                    
                    // Alternate antara audio elements
                    this.currentIndex = (this.currentIndex + 1) % this.audioElements.length;
                    
                } catch (error) {
                    console.error('Error in playNotification:', error);
                    this.fallbackPlay();
                }
            }
            
            fallbackPlay() {
                this.logAction('Trying fallback playback...');
                for (let i = 0; i < this.audioElements.length; i++) {
                    const audio = this.audioElements[i];
                    try {
                        audio.currentTime = 0;
                        audio.play();
                        this.logAction(`Fallback successful (Audio ${i + 1})`);
                        this.currentIndex = (i + 1) % this.audioElements.length;
                        break;
                    } catch (error) {
                        console.warn(`Fallback ${i + 1} failed`);
                    }
                }
            }
            
            updateStatus(message) {
                if (this.statusElement) {
                    this.statusElement.textContent = message;
                }
            }
            
            logAction(action) {
                console.log(`ðŸ”” ${action}`);
                if (this.lastActionElement) {
                    this.lastActionElement.textContent = action;
                }
            }
            
            // Untuk testing manual
            testNotification() {
                this.logAction('Manual test triggered');
                this.playNotification();
            }
            
            // Enable/disable debug panel
            toggleDebug() {
                if (this.debugPanel) {
                    this.debugPanel.style.display = 
                        this.debugPanel.style.display === 'none' ? 'block' : 'none';
                }
            }
        }
        
        // Initialize system
        let streamNotifier;
        
        document.addEventListener('DOMContentLoaded', function() {
            streamNotifier = new SocialStreamNotifier();
            
            // Auto-test setelah 3 detik
            setTimeout(() => {
                streamNotifier.logAction('Auto-test: System ready for Social Stream Ninja');
            }, 3000);
        });
        
        // Global functions untuk external access
        window.SocialStreamNotifier = {
            play: function() {
                if (streamNotifier) streamNotifier.playNotification();
            },
            test: function() {
                if (streamNotifier) streamNotifier.testNotification();
            },
            toggleDebug: function() {
                if (streamNotifier) streamNotifier.toggleDebug();
            }
        };
        
        // Simulasi message dari Social Stream Ninja (untuk testing)
        function simulateSocialStreamMessage() {
            const testMessages = [
                { type: 'social-stream-event', action: 'new_message', user: 'test_user' },
                'social_stream_ninja_message',
                { action: 'new_message', platform: 'youtube' },
                'new_chat_message'
            ];
            
            const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
            window.postMessage(randomMessage, '*');
        }
        
        // Auto-simulasi untuk testing (bisa di-disable)
        setTimeout(() => {
            console.log('Testing system with simulated message in 5 seconds...');
            setTimeout(() => {
                simulateSocialStreamMessage();
            }, 5000);
        }, 2000);
        
    </script>
</body>
</html>
